
\chapter{Runtime System Improvements}
\label{chap:rts}

\status{This chapter is ready for proof reading.}

Early in the project
we tested two manually parallelised programs:
a raytracer and a mandelbrot image generator.
Both of them have a single significant loop
whose iterations are independent of one another.
We expect that automatic parallelisation would parallelise this loop
as it is the best place to introduce parallelism.
When we parallelised this loop manually we did
we did not get the speedups that we expected.
Therefore,
we chose to address the performance problems
before we worked on automatic parallelism.

In this chapter we investigate and correct these performance problems.
We start with the garbage collector in section \ref{sec:rts_gc};
we analyse the collector's effects on performance and tune its parameters
to improve performance.
In section \ref{sec:original_scheduling} we describe how the existing runtime
system schedules sparks,
and provide background material for
section \ref{sec:original_scheduling_performance},
which benchmarks the runtime system and describes two significant problems with
spark scheduling.
We address one of these problems by introducing work stealing in section
\ref{sec:rts_work_stealing}.
Then in section \ref{sec:rts_reorder} we reorder conjuncts in independent
parallel conjunctions to work around the other spark scheduling problem.
Finally, in section \ref{sec:rts_work_stealing2} we make further improvements to
work stealing and change how idle engines look for work, sleep and are
woken up.

\input{rts_gc}
\input{rts_original_scheduling}
\input{rts_original_scheduling_performance}
\input{rts_work_stealing}
\input{rts_reorder}
%\input{rts_thread_pinning}
\input{rts_work_stealing2}

%\section{Proposed scheduling tweaks}
%\label{sec:proposed_tweaks}
%\status{Not written, May move to TS chapter}
%
%I really think that this section will move to the \tscope chapter,
%it will have more in common with that chapter and more data will be
%available.
%Secondly, \tscope can be used with micro-benchmarks to measure the
%average costs of certain operations in the RTS.
%I will not write it until at least the rest of this chapter is finished.

